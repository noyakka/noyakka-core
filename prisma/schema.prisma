generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model ServiceM8Connection {
  id            String   @id @default(cuid())
  vendor_uuid   String   @unique
  access_token  String
  refresh_token String?
  expires_at    DateTime?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
}

model OAuthState {
  id            String   @id @default(cuid())
  state         String   @unique
  vendor_uuid   String?
  redirect_uri  String
  created_at    DateTime @default(now())
  expires_at    DateTime
}

model BusinessConfig {
  servicem8_vendor_uuid String @id
  business_name         String
  timezone              String @default("Australia/Brisbane")
  cutoff_time           String @default("14:30")
  window_morning_start  String @default("08:00")
  window_morning_end    String @default("12:00")
  window_arvo_start     String @default("13:00")
  window_arvo_end       String @default("16:00")
  capacity_per_window   Int    @default(6)
  emergency_reserve     Int    @default(2)
  holds_ttl_minutes     Int    @default(15)
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt
}

model VendorConfig {
  servicem8_vendor_uuid String @id
  business_name         String
  timezone              String @default("Australia/Brisbane")
  morning_capacity      Int
  arvo_capacity         Int
  emergency_reserve     Int    @default(2)
  working_days          String @default("[\"mon\",\"tue\",\"wed\",\"thu\",\"fri\"]")
  cutoff_today_arvo     String @default("14:30")
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt
}

model AllocationWindowMap {
  id                    String   @id @default(cuid())
  servicem8_vendor_uuid String   @unique
  morning_window_uuid   String?
  arvo_window_uuid      String?
  raw_windows_json      String?
  updated_at            DateTime @updatedAt
}

model WindowCapacity {
  id                    String @id @default(cuid())
  servicem8_vendor_uuid String
  date                  String
  window                String
  max_capacity          Int
  booked_count          Int @default(0)
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  @@unique([servicem8_vendor_uuid, date, window])
}

model WindowHold {
  id                    String @id @default(cuid())
  servicem8_vendor_uuid String
  job_uuid              String
  customer_mobile       String
  date                  String
  window                String
  status                String   @default("PENDING")
  expires_at            DateTime
  created_at            DateTime @default(now())
  confirmed_at          DateTime?
}

model JobWindowBooking {
  job_uuid              String @id
  servicem8_vendor_uuid String
  date                  String
  window                String
  allocation_uuid       String
  status                String   @default("confirmed")
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt
}

model ToolRun {
  id          String   @id @default(uuid())
  vendor_uuid String
  endpoint    String
  call_id     String
  status      String
  result_json String?
  error_code  String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@unique([vendor_uuid, endpoint, call_id])
}

model PendingDecision {
  id                    String   @id @default(cuid())
  job_uuid              String   @unique
  allocation_uuid       String?
  servicem8_vendor_uuid String
  customer_mobile       String
  tradie_mobile         String
  flags_json            String
  distance_km           Float?
  distance_band         String?
  template_a            String
  template_b            String
  created_at            DateTime @default(now())
  expires_at            DateTime
  resolved_action       String?
  resolved_at           DateTime?
}

model OverrunMonitorState {
  allocation_uuid            String   @id
  job_uuid                   String?
  staff_uuid                 String?
  allocation_date            String?
  overrun_detected_at        DateTime?
  delay_minutes              Int?
  delay_sms_sent_at          DateTime?
  thirty_away_sms_sent_at    DateTime?
  major_alert_sent_at        DateTime?
  created_at                 DateTime @default(now())
  updated_at                 DateTime @updatedAt
}

model OverrunSmsEvent {
  id                     String   @id @default(cuid())
  source_allocation_uuid String
  target_allocation_uuid String?
  target_job_uuid        String
  sms_type               String
  last_sms_sent_at       DateTime
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  @@unique([source_allocation_uuid, target_job_uuid, sms_type])
}
